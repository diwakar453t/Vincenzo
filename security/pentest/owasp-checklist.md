# PreSkool ERP â€” Penetration Testing Checklist
# OWASP TOP 10 (2021) + Application-Specific Tests
# Run before each major release and quarterly for compliance

## Environment Setup

```bash
# Target (local development)
export TARGET="http://localhost:8000"
export API="$TARGET/api/v1"

# Auth token (replace with actual test user)
TOKEN=$(curl -s -X POST "$API/auth/login" \
  -H "Content-Type: application/json" \
  -H "X-Tenant-ID: test-college" \
  -d '{"email":"pentest@test.com","password":"PentestPass1!"}' \
  | python3 -c "import sys,json; print(json.load(sys.stdin)['access_token'])")
echo "Token: $TOKEN"
```

---

## A01: Broken Access Control

### Test 1: Horizontal Privilege Escalation
```bash
# Create user in tenant-A, try to access tenant-B data
curl -s "$API/students" \
  -H "Authorization: Bearer $TOKEN_TENANT_A" \
  -H "X-Tenant-ID: tenant-b"
# Expected: 403 Forbidden
```

### Test 2: IDOR â€” Student Record Access
```bash
# Try to access student from different tenant
for id in 1 2 3 4 5; do
  STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
    "$API/students/$id" \
    -H "Authorization: Bearer $TOKEN" \
    -H "X-Tenant-ID: test-college")
  echo "Student $id: HTTP $STATUS"
done
# Expected: 403 or 404 for cross-tenant IDs
```

### Test 3: Admin Endpoint Access as Teacher
```bash
curl -s -X DELETE "$API/students/1" \
  -H "Authorization: Bearer $TEACHER_TOKEN" \
  -H "X-Tenant-ID: test-college"
# Expected: 403 Forbidden
```

---

## A02: Cryptographic Failures

### Test 4: JWT Algorithm Confusion (None Algorithm)
```bash
# Try JWT with alg=none
HEADER=$(echo -n '{"alg":"none","typ":"JWT"}' | base64 | tr -d '=')
PAYLOAD=$(echo -n '{"sub":"1","role":"admin","tenant_id":"test-college"}' | base64 | tr -d '=')
NONE_TOKEN="$HEADER.$PAYLOAD."

curl -s "$API/auth/profile" \
  -H "Authorization: Bearer $NONE_TOKEN"
# Expected: 401 Unauthorized
```

### Test 5: Weak JWT Secret Brute Force
```bash
# Check if default JWT secret is still in use (dev only)
python3 -c "
import jwt
try:
    payload = jwt.decode('$TOKEN', 'your-secret-key-change-in-production', algorithms=['HS256'])
    print('VULNERABLE: Default JWT secret in use!')
except:
    print('OK: Non-default JWT secret')
"
```

### Test 6: Password in Response
```bash
curl -s "$API/auth/profile" \
  -H "Authorization: Bearer $TOKEN" | python3 -c "
import sys, json
data = json.load(sys.stdin)
if 'password' in str(data).lower() or 'hashed_password' in str(data).lower():
    print('VULNERABLE: Password data exposed in response')
else:
    print('OK: No password in response')
"
```

---

## A03: Injection

### Test 7: SQL Injection in Query Parameters
```bash
PAYLOADS=(
  "1' OR '1'='1"
  "1; DROP TABLE students--"
  "' UNION SELECT * FROM users--"
  "admin' --"
  "1' AND SLEEP(5)--"
)

for payload in "${PAYLOADS[@]}"; do
  STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
    "$API/students?search=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$payload'))")" \
    -H "Authorization: Bearer $TOKEN" \
    -H "X-Tenant-ID: test-college")
  echo "Payload: $payload â†’ HTTP $STATUS"
  # Expected: 400 (rejected) or 200 (safe, parameterized query)
  # FAIL if response contains table data or 500 error
done
```

### Test 8: XSS in Student Name
```bash
XSS_PAYLOADS=(
  "<script>alert('XSS')</script>"
  "<img src=x onerror=alert(1)>"
  "javascript:alert(1)"
  "'><svg/onload=alert('xss')>"
)

for payload in "${XSS_PAYLOADS[@]}"; do
  RESPONSE=$(curl -s -X POST "$API/students" \
    -H "Authorization: Bearer $TOKEN" \
    -H "X-Tenant-ID: test-college" \
    -H "Content-Type: application/json" \
    -d "{\"first_name\": \"$payload\", \"last_name\": \"Test\"}")
  echo "XSS test: $(echo $RESPONSE | python3 -c "import sys,json; d=json.load(sys.stdin); print('STORED' if '<script>' in str(d) else 'SANITIZED')" 2>/dev/null || echo "ERROR")"
done
```

### Test 9: Path Traversal in File Upload/Download
```bash
# Try to read /etc/passwd via file endpoint
curl -s "$API/files/../../../etc/passwd" \
  -H "Authorization: Bearer $TOKEN"
# Expected: 400 or 404

# Test encoded path traversal
curl -s "$API/files/%2e%2e%2f%2e%2e%2fetc%2fpasswd" \
  -H "Authorization: Bearer $TOKEN"
# Expected: 400 or 404
```

---

## A04: Insecure Design

### Test 10: Mass Assignment
```bash
# Try to set admin role during registration
curl -s -X POST "$API/auth/register" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "hacker@test.com",
    "password": "Hack3r!Pass",
    "full_name": "Hacker",
    "tenant_id": "test-college",
    "role": "admin",
    "is_superuser": true,
    "is_verified": true
  }' | python3 -c "import sys,json; d=json.load(sys.stdin); print('ROLE:', d.get('user',{}).get('role','N/A'))"
# Expected: role should be 'student' (default) or whatever is allowed
```

---

## A05: Security Misconfiguration

### Test 11: Information Disclosure in Headers
```bash
curl -sI "$TARGET" | grep -iE "(server|x-powered-by|x-aspnet)"
# Expected: No server version info
```

### Test 12: Debug Information in Errors
```bash
# Force a server error and check for stack traces
curl -s "$API/students/99999999999999999999" \
  -H "Authorization: Bearer $TOKEN" \
  -H "X-Tenant-ID: test-college"
# Expected: Generic error message, no Python traceback
```

### Test 13: Security Headers
```bash
python3 << 'EOF'
import urllib.request

url = "http://localhost:8000/api/v1/health"
try:
    resp = urllib.request.urlopen(url)
    headers = dict(resp.headers)
    
    required = {
        "x-content-type-options": "nosniff",
        "x-frame-options": "DENY",
    }
    
    for header, expected in required.items():
        value = headers.get(header, "MISSING")
        if expected.lower() in value.lower():
            print(f"âœ… {header}: {value}")
        else:
            print(f"âŒ MISSING: {header} (got: {value})")
except Exception as e:
    print(f"Connection error: {e}")
EOF
```

---

## A07: Identification & Authentication Failures

### Test 14: Account Lockout
```bash
echo "Testing account lockout..."
for i in {1..6}; do
  RESPONSE=$(curl -s -X POST "$API/auth/login" \
    -H "Content-Type: application/json" \
    -H "X-Tenant-ID: test-college" \
    -d '{"email":"test@test.com","password":"WrongPassword123!"}')
  STATUS=$(echo "$RESPONSE" | python3 -c "import sys,json; print(json.load(sys.stdin).get('detail','N/A'))" 2>/dev/null)
  echo "Attempt $i: $STATUS"
done
# Expected: After 5 attempts, account should be locked
```

### Test 15: Brute Force Rate Limiting
```bash
echo "Testing rate limiting on login..."
for i in {1..20}; do
  HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
    -X POST "$API/auth/login" \
    -H "Content-Type: application/json" \
    -H "X-Tenant-ID: test-college" \
    -d '{"email":"test@test.com","password":"Password123!"}')
  echo "Request $i: HTTP $HTTP_CODE"
  if [[ "$HTTP_CODE" == "429" ]]; then
    echo "âœ… Rate limiting working â€” blocked at request $i"
    break
  fi
done
```

### Test 16: Timing Attack on Login
```bash
python3 << 'EOF'
import time, urllib.request, json, urllib.error

def test_login(email, password):
    data = json.dumps({"email": email, "password": password}).encode()
    req = urllib.request.Request(
        "http://localhost:8000/api/v1/auth/login",
        data=data,
        headers={"Content-Type": "application/json", "X-Tenant-ID": "test-college"},
        method="POST"
    )
    start = time.time()
    try:
        urllib.request.urlopen(req)
    except urllib.error.HTTPError:
        pass
    return time.time() - start

# Test: response time should be ~same for valid vs invalid email
times_valid_email = [test_login("existing@test.com", "WrongPass1!") for _ in range(5)]
times_invalid_email = [test_login("nonexistent@fake.com", "WrongPass1!") for _ in range(5)]

avg_valid = sum(times_valid_email) / len(times_valid_email)
avg_invalid = sum(times_invalid_email) / len(times_invalid_email)
diff = abs(avg_valid - avg_invalid)

print(f"Valid email avg: {avg_valid:.3f}s")
print(f"Invalid email avg: {avg_invalid:.3f}s")
print(f"Timing difference: {diff:.3f}s")
if diff > 0.1:
    print("âš ï¸  Timing difference > 100ms â€” possible timing attack vector")
else:
    print("âœ… Timing attack protection: OK")
EOF
```

---

## A09: Security Logging & Monitoring Failures

### Test 17: Audit Log Verification
```bash
# Trigger failed login and check audit log
curl -s -X POST "$API/auth/login" \
  -H "Content-Type: application/json" \
  -H "X-Tenant-ID: test-college" \
  -d '{"email":"test@test.com","password":"WrongPassword!"}' > /dev/null

# Check backend logs for AUTH_FAILURE event
docker logs preskool-backend 2>&1 | grep -i "AUTH_FAILURE" | tail -3
# Expected: AUTH_FAILURE log entry with email and IP
```

---

## A10: Server-Side Request Forgery (SSRF)

### Test 18: SSRF via URL Parameters
```bash
# Test if any URL parameters allow fetching arbitrary URLs
SSRF_URLS=(
  "http://localhost:8000/api/v1/health"
  "http://169.254.169.254/latest/meta-data/"  # AWS metadata
  "file:///etc/passwd"
  "http://0.0.0.0:22"
)

for url in "${SSRF_URLS[@]}"; do
  # Test any endpoint that might accept URLs
  curl -s "$API/files/fetch?url=$(python3 -c "import urllib.parse; print(urllib.parse.quote('$url'))")" \
    -H "Authorization: Bearer $TOKEN" 2>/dev/null | head -1 || echo "OK: Endpoint not accessible"
done
```

---

## Results Template

| Test | CVE/OWASP | Status | Notes |
|------|-----------|--------|-------|
| Horizontal privilege escalation | A01 | âœ… Pass | |
| IDOR â€” student records | A01 | âœ… Pass | |
| JWT alg=none attack | A02 | âœ… Pass | |
| Default JWT secret | A02 | âœ… Pass | Changed in prod |
| SQL injection | A03 | âœ… Pass | ORM + regex check |
| XSS in input fields | A03 | âœ… Pass | HTML escaped |
| Path traversal | A03 | âœ… Pass | Regex blocked |
| Mass assignment | A04 | âœ… Pass | |
| Info disclosure in errors | A05 | âœ… Pass | DEBUG=False in prod |
| Security headers | A05 | âœ… Pass | All present |
| Account lockout | A07 | âœ… Pass | 5 attempts â†’ lock |
| Rate limiting | A07 | âœ… Pass | 120/min per IP |
| Timing attacks | A07 | âœ… Pass | Constant time |
| Audit logging | A09 | âœ… Pass | |
| SSRF | A10 | âœ… Pass | |

---

## Remediation Priorities

| Priority | Issue | Action |
|----------|-------|--------|
| ðŸ”´ P0 | Default JWT secret | Change `JWT_SECRET_KEY` before production |
| ðŸ”´ P0 | DEBUG=True in prod | Set `DEBUG=False`, `APP_ENV=production` |
| ðŸŸ¡ P1 | CORS wildcard | Already fixed â€” env-specific origins |
| ðŸŸ¡ P1 | Allow-list all uploads | Validate file type + scan for malware |
| ðŸŸ¢ P2 | HTTP Strict Transport | nginx HSTS configured |
| ðŸŸ¢ P2 | CSP headers | Added via SecurityHeadersMiddleware |
