# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# Alertmanager Configuration â€” PreSkool ERP (200+ Colleges)
# Full notification routing: Slack, Email, PagerDuty, Webhook
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

global:
  resolve_timeout: 5m

  # â”€â”€ Email (SMTP) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  smtp_smarthost: "${SMTP_HOST:-smtp.gmail.com}:${SMTP_PORT:-587}"
  smtp_from: "${ALERT_EMAIL_FROM:-alerts@preskool.com}"
  smtp_auth_username: "${ALERT_EMAIL_FROM:-alerts@preskool.com}"
  smtp_auth_password: "${ALERT_EMAIL_PASSWORD:-}"
  smtp_require_tls: true

  # â”€â”€ Slack â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  slack_api_url: "${SLACK_WEBHOOK_URL:-https://hooks.slack.com/services/CONFIGURE_ME}"

  # â”€â”€ PagerDuty â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  pagerduty_url: "https://events.pagerduty.com/v2/enqueue"

# â”€â”€ Custom Templates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
templates:
  - "/etc/alertmanager/templates/*.tmpl"

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# ROUTING TREE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
route:
  receiver: "slack-default"
  group_by: ["alertname", "severity", "tenant_id"]
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h

  routes:
    # â”€â”€ P0: Critical â†’ PagerDuty + Slack + Email (On-Call) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - match:
        severity: critical
      receiver: "pagerduty-critical"
      group_wait: 10s
      repeat_interval: 30m
      continue: true  # Also send to Slack

    - match:
        severity: critical
      receiver: "slack-critical"
      group_wait: 10s
      repeat_interval: 1h
      continue: true

    - match:
        severity: critical
      receiver: "email-oncall"
      group_wait: 30s
      repeat_interval: 2h

    # â”€â”€ P1: Warning â†’ Slack + Email (Engineering) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - match:
        severity: warning
      receiver: "slack-warning"
      repeat_interval: 4h
      continue: true

    - match:
        severity: warning
      receiver: "email-engineering"
      repeat_interval: 8h

    # â”€â”€ P2: Info â†’ Slack quiet channel only â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - match:
        severity: info
      receiver: "slack-info"
      repeat_interval: 12h

    # â”€â”€ Security alerts â†’ dedicated channel + email â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - match_re:
        alertname: "(AuthBruteForce|SuspiciousLoginPattern|TooManyFailedLogins|WAFHighBlockRate)"
      receiver: "slack-security"
      group_wait: 5s
      repeat_interval: 15m
      continue: true

    - match_re:
        alertname: "(AuthBruteForce|SuspiciousLoginPattern|TooManyFailedLogins|WAFHighBlockRate)"
      receiver: "email-security"
      repeat_interval: 1h

    # â”€â”€ Capacity alerts â†’ ops channel + email â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    - match_re:
        alertname: "(DiskSpaceCritical|DiskSpaceLow|HighCPUUsage|HighMemoryUsage|DatabaseConnectionPoolExhausted)"
      receiver: "slack-capacity"
      repeat_interval: 2h

    # â”€â”€ Tenant-specific alerts â†’ webhook for tenant notification â”€â”€â”€â”€â”€â”€
    - match_re:
        alertname: "(TenantInactive|HighTenantErrorRate)"
      receiver: "webhook-tenant-alerts"
      repeat_interval: 24h

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# RECEIVERS
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
receivers:
  # â”€â”€ Default (catch-all) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: "slack-default"
    slack_configs:
      - channel: "#preskool-alerts"
        title: '{{ template "slack.title" . }}'
        text: '{{ template "slack.text" . }}'
        send_resolved: true
        color: '{{ template "slack.color" . }}'
        actions:
          - type: button
            text: "ğŸ“– Runbook"
            url: '{{ (index .Alerts 0).Annotations.runbook_url }}'
          - type: button
            text: "ğŸ“Š Dashboard"
            url: '{{ (index .Alerts 0).Annotations.dashboard_url }}'

  # â”€â”€ Critical â†’ PagerDuty â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: "pagerduty-critical"
    pagerduty_configs:
      - routing_key: "${PAGERDUTY_ROUTING_KEY:-CONFIGURE_ME}"
        severity: critical
        description: '{{ .GroupLabels.alertname }}: {{ (index .Alerts 0).Annotations.summary }}'
        details:
          alertname: "{{ .GroupLabels.alertname }}"
          severity: "{{ .GroupLabels.severity }}"
          description: "{{ (index .Alerts 0).Annotations.description }}"
          runbook: "{{ (index .Alerts 0).Annotations.runbook_url }}"

  # â”€â”€ Critical â†’ Slack â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: "slack-critical"
    slack_configs:
      - channel: "#preskool-critical"
        title: 'ğŸš¨ CRITICAL: {{ .GroupLabels.alertname }}'
        text: '{{ template "slack.text" . }}'
        send_resolved: true
        color: "danger"
        actions:
          - type: button
            text: "ğŸ“– Runbook"
            url: '{{ (index .Alerts 0).Annotations.runbook_url }}'
          - type: button
            text: "ğŸ“Š Grafana"
            url: "http://localhost:3200/grafana"

  # â”€â”€ Critical â†’ Email (On-Call) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: "email-oncall"
    email_configs:
      - to: "${ONCALL_EMAIL:-oncall@preskool.com}"
        subject: '[CRITICAL] PreSkool: {{ .GroupLabels.alertname }}'
        html: '{{ template "email.html" . }}'
        send_resolved: true
        require_tls: true

  # â”€â”€ Warning â†’ Slack â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: "slack-warning"
    slack_configs:
      - channel: "#preskool-alerts"
        title: 'âš ï¸ WARNING: {{ .GroupLabels.alertname }}'
        text: '{{ template "slack.text" . }}'
        send_resolved: true
        color: "warning"

  # â”€â”€ Warning â†’ Email (Engineering) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: "email-engineering"
    email_configs:
      - to: "${ENGINEERING_EMAIL:-engineering@preskool.com}"
        subject: '[WARNING] PreSkool: {{ .GroupLabels.alertname }}'
        html: '{{ template "email.html" . }}'
        send_resolved: true

  # â”€â”€ Info â†’ Slack (Quiet) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: "slack-info"
    slack_configs:
      - channel: "#preskool-info"
        title: 'â„¹ï¸ {{ .GroupLabels.alertname }}'
        text: '{{ template "slack.text" . }}'
        send_resolved: true
        color: "#36a64f"

  # â”€â”€ Security â†’ Slack â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: "slack-security"
    slack_configs:
      - channel: "#preskool-security"
        title: 'ğŸ”’ SECURITY: {{ .GroupLabels.alertname }}'
        text: '{{ template "slack.text" . }}'
        send_resolved: true
        color: "danger"

  # â”€â”€ Security â†’ Email â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: "email-security"
    email_configs:
      - to: "${SECURITY_EMAIL:-security@preskool.com}"
        subject: '[SECURITY] PreSkool: {{ .GroupLabels.alertname }}'
        html: '{{ template "email.html" . }}'
        send_resolved: true

  # â”€â”€ Capacity â†’ Slack â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: "slack-capacity"
    slack_configs:
      - channel: "#preskool-infrastructure"
        title: 'ğŸ’¾ CAPACITY: {{ .GroupLabels.alertname }}'
        text: '{{ template "slack.text" . }}'
        send_resolved: true
        color: "warning"

  # â”€â”€ Tenant alerts â†’ Webhook â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - name: "webhook-tenant-alerts"
    webhook_configs:
      - url: "http://backend:8000/api/v1/webhooks/alerts"
        send_resolved: true
        max_alerts: 10

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# INHIBITION RULES â€” Suppress noise during cascading failures
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
inhibit_rules:
  # Critical suppresses warning for same alert
  - source_match:
      severity: critical
    target_match:
      severity: warning
    equal: ["alertname"]

  # App down suppresses all app-level alerts
  - source_match:
      alertname: AppDown
    target_match_re:
      alertname: "(HighErrorRate|HighLatency|TooManyInFlightRequests)"
    equal: []

  # Postgres down suppresses DB-level alerts
  - source_match:
      alertname: PostgresDown
    target_match_re:
      alertname: "(DatabaseConnectionPoolExhausted|SlowQueries|PostgresHighConnections|PostgresDeadlocks)"
    equal: []

  # Redis down suppresses cache alerts
  - source_match:
      alertname: RedisDown
    target_match_re:
      alertname: "(RedisHighMemory|RedisHighClients)"
    equal: []

  # High CPU suppresses latency warnings (root cause)
  - source_match:
      alertname: HighCPUUsage
    target_match:
      alertname: HighLatency
    equal: []
