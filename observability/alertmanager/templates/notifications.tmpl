{{ define "slack.title" }}
{{- if eq .Status "firing" -}}
  {{- if eq (index .GroupLabels "severity") "critical" -}}üö®{{- else if eq (index .GroupLabels "severity") "warning" -}}‚ö†Ô∏è{{- else -}}‚ÑπÔ∏è{{- end }} {{ .GroupLabels.alertname }} [{{ .Status | toUpper }}]
{{- else -}}
  ‚úÖ {{ .GroupLabels.alertname }} [RESOLVED]
{{- end -}}
{{ end }}

{{ define "slack.color" }}
{{- if eq .Status "firing" -}}
  {{- if eq (index .GroupLabels "severity") "critical" -}}danger{{- else if eq (index .GroupLabels "severity") "warning" -}}warning{{- else -}}#36a64f{{- end -}}
{{- else -}}good{{- end -}}
{{ end }}

{{ define "slack.text" }}
*Environment:* {{ (index .Alerts 0).Labels.environment | default "production" }}
*Severity:* {{ .GroupLabels.severity | toUpper }}
{{ if (index .Alerts 0).Labels.tenant_id }}*Tenant:* {{ (index .Alerts 0).Labels.tenant_id }}{{ end }}

{{ range .Alerts }}
---
{{ .Annotations.summary }}
{{ if .Annotations.description }}> {{ .Annotations.description }}{{ end }}
{{ if .Annotations.runbook_url }}üìñ <{{ .Annotations.runbook_url }}|View Runbook>{{ end }}
{{ end }}

*Fired at:* {{ (index .Alerts 0).StartsAt.Format "2006-01-02 15:04:05 MST" }}
{{ if eq .Status "resolved" }}*Resolved at:* {{ (index .Alerts 0).EndsAt.Format "2006-01-02 15:04:05 MST" }}{{ end }}
{{ end }}

{{ define "email.subject" }}
[{{ .GroupLabels.severity | toUpper }}] PreSkool ERP: {{ .GroupLabels.alertname }}
{{ end }}

{{ define "email.html" }}
<!DOCTYPE html>
<html>
<head>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
    .container { max-width: 600px; margin: 0 auto; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .header { padding: 20px; color: white; }
    .header.critical { background: #dc3545; }
    .header.warning { background: #ffc107; color: #333; }
    .header.info { background: #17a2b8; }
    .header.resolved { background: #28a745; }
    .body { padding: 20px; }
    .alert-card { border-left: 4px solid #dc3545; padding: 12px; margin: 10px 0; background: #fff8f8; border-radius: 0 4px 4px 0; }
    .alert-card.resolved { border-color: #28a745; background: #f8fff8; }
    .meta { color: #666; font-size: 13px; margin-top: 15px; }
    .btn { display: inline-block; padding: 10px 20px; border-radius: 5px; text-decoration: none; color: white; margin: 5px; }
    .btn-primary { background: #007bff; }
    .btn-secondary { background: #6c757d; }
    table { width: 100%; border-collapse: collapse; margin: 10px 0; }
    td { padding: 8px; border-bottom: 1px solid #eee; }
    td:first-child { font-weight: 600; width: 120px; color: #555; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header {{ if eq .Status "resolved" }}resolved{{ else }}{{ .GroupLabels.severity }}{{ end }}">
      <h2 style="margin:0;">
        {{ if eq .Status "firing" }}
          {{ if eq .GroupLabels.severity "critical" }}üö®{{ else if eq .GroupLabels.severity "warning" }}‚ö†Ô∏è{{ else }}‚ÑπÔ∏è{{ end }}
        {{ else }}‚úÖ{{ end }}
        PreSkool ERP ‚Äî {{ .GroupLabels.alertname }}
      </h2>
      <p style="margin:5px 0 0;">{{ .Status | toUpper }} {{ if eq .Status "resolved" }}(Auto-resolved){{ end }}</p>
    </div>
    <div class="body">
      <table>
        <tr><td>Alert</td><td>{{ .GroupLabels.alertname }}</td></tr>
        <tr><td>Severity</td><td>{{ .GroupLabels.severity | toUpper }}</td></tr>
        <tr><td>Environment</td><td>{{ (index .Alerts 0).Labels.environment | default "production" }}</td></tr>
        {{ if (index .Alerts 0).Labels.tenant_id }}<tr><td>Tenant</td><td>{{ (index .Alerts 0).Labels.tenant_id }}</td></tr>{{ end }}
        <tr><td>Fired at</td><td>{{ (index .Alerts 0).StartsAt.Format "2006-01-02 15:04:05 MST" }}</td></tr>
        {{ if eq .Status "resolved" }}<tr><td>Resolved at</td><td>{{ (index .Alerts 0).EndsAt.Format "2006-01-02 15:04:05 MST" }}</td></tr>{{ end }}
      </table>

      {{ range .Alerts }}
      <div class="alert-card {{ if eq $.Status "resolved" }}resolved{{ end }}">
        <strong>{{ .Annotations.summary }}</strong>
        {{ if .Annotations.description }}<p>{{ .Annotations.description }}</p>{{ end }}
      </div>
      {{ end }}

      <div style="margin-top: 20px;">
        {{ if (index .Alerts 0).Annotations.runbook_url }}
        <a href="{{ (index .Alerts 0).Annotations.runbook_url }}" class="btn btn-primary">üìñ Open Runbook</a>
        {{ end }}
        <a href="http://localhost:3200/grafana" class="btn btn-secondary">üìä Grafana Dashboard</a>
        <a href="http://localhost:9093" class="btn btn-secondary">üîî Alertmanager</a>
      </div>

      <p class="meta">
        This alert was generated by PreSkool ERP monitoring system.<br>
        Do not reply to this email. Contact the on-call engineer via PagerDuty.
      </p>
    </div>
  </div>
</body>
</html>
{{ end }}
