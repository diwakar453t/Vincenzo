# ═══════════════════════════════════════════════════════════════════════
# Promtail — Log Shipper (collects logs → sends to Loki)
# Scrapes Docker container stdout/stderr logs
# ═══════════════════════════════════════════════════════════════════════
server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    batchwait: 1s
    batchsize: 1048576  # 1MB
    timeout: 10s
    tenant_id: preskool

scrape_configs:
  # ── Docker Container Logs ───────────────────────────────────────────
  - job_name: docker
    static_configs:
      - targets:
          - localhost
        labels:
          job: preskool
          __path__: /var/log/containers/*.log

  # ── Docker Compose Logs (via Docker socket) ─────────────────────────
  - job_name: docker-compose
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values: ["com.docker.compose.project=preskool-erp"]
    relabel_configs:
      # Extract service name from container label
      - source_labels: ["__meta_docker_container_label_com_docker_compose_service"]
        target_label: service
      - source_labels: ["__meta_docker_container_name"]
        regex: "/(.*)"
        target_label: container
      - source_labels: ["__meta_docker_container_label_com_docker_compose_project"]
        target_label: project

    pipeline_stages:
      # ── Parse JSON logs from backend ──────────────────────────────
      - match:
          selector: '{service="backend"}'
          stages:
            - json:
                expressions:
                  level: level
                  tenant_id: tenant_id
                  request_id: request_id
                  message: message
                  duration_ms: duration_ms
                  status_code: status_code
                  method: method
                  path: path
                  logger: logger
            - labels:
                level:
                tenant_id:
                logger:
            - timestamp:
                source: timestamp
                format: "2006-01-02T15:04:05.000Z"
            - output:
                source: message

      # ── Parse JSON logs from celery worker ────────────────────────
      - match:
          selector: '{service="celery-worker"}'
          stages:
            - json:
                expressions:
                  level: level
                  tenant_id: tenant_id
                  message: message
            - labels:
                level:
                tenant_id:
            - output:
                source: message

      # ── Parse PostgreSQL logs ─────────────────────────────────────
      - match:
          selector: '{service="postgres"}'
          stages:
            - regex:
                expression: '^(?P<timestamp>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d+) \w+ \[(?P<pid>\d+)\] (?P<level>\w+):  (?P<message>.*)'
            - labels:
                level:

      # ── Drop health check noise ──────────────────────────────────
      - match:
          selector: '{service="backend"}'
          stages:
            - drop:
                expression: "/api/v1/health"
                drop_counter_reason: "health_check"

      # ── Metrics from logs ─────────────────────────────────────────
      - metrics:
          log_lines_total:
            type: Counter
            description: "Total log lines by service and level"
            source: level
            config:
              match_all: true
              action: inc
          request_duration_ms:
            type: Histogram
            description: "Request duration from structured logs"
            source: duration_ms
            config:
              buckets: [10, 25, 50, 100, 250, 500, 1000, 2500, 5000]
