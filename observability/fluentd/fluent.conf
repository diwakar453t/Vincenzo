# ═══════════════════════════════════════════════════════════════════════
# Fluentd — Alternative Log Shipper (enterprise-grade)
# Use this instead of Promtail for Kubernetes or multi-destination output
# ═══════════════════════════════════════════════════════════════════════

# ── Source: Docker container logs ─────────────────────────────────────
<source>
  @type forward
  port 24224
  bind 0.0.0.0
  tag preskool
</source>

# ── Source: Tail container logs ───────────────────────────────────────
<source>
  @type tail
  path /var/log/containers/preskool-*.log
  pos_file /var/log/fluentd-containers.log.pos
  tag preskool.containers
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S%z
    keep_time_key true
  </parse>
</source>

# ── Filter: Parse JSON from backend ──────────────────────────────────
<filter preskool.containers>
  @type parser
  key_name log
  reserve_data true
  remove_key_name_field true
  <parse>
    @type json
    time_key timestamp
    keep_time_key true
  </parse>
</filter>

# ── Filter: Add Kubernetes metadata (K8s only) ───────────────────────
# <filter preskool.**>
#   @type kubernetes_metadata
#   @id filter_kube_metadata
# </filter>

# ── Filter: Tag with tenant_id ───────────────────────────────────────
<filter preskool.**>
  @type record_transformer
  enable_ruby true
  <record>
    service ${record["service"] || tag_parts[1] || "unknown"}
    cluster "preskool-${ENV['ENVIRONMENT'] || 'dev'}"
    hostname "#{Socket.gethostname}"
  </record>
</filter>

# ── Filter: Drop health check logs ───────────────────────────────────
<filter preskool.**>
  @type grep
  <exclude>
    key path
    pattern /\/api\/v1\/health/
  </exclude>
</filter>

# ── Output: Grafana Loki ─────────────────────────────────────────────
<match preskool.**>
  @type loki
  url "http://loki:3100"
  flush_interval 5s
  flush_at_shutdown true
  buffer_chunk_limit 1m

  <label>
    service
    tenant_id
    level
    cluster
  </label>

  <buffer>
    @type file
    path /var/log/fluentd-buffers/loki
    flush_mode interval
    flush_interval 5s
    chunk_limit_size 2M
    total_limit_size 256M
    overflow_action drop_oldest_chunk
    retry_max_interval 30s
    retry_forever true
  </buffer>
</match>

# ── Output: Elasticsearch (alternative) ──────────────────────────────
# <match preskool.**>
#   @type elasticsearch
#   host elasticsearch
#   port 9200
#   logstash_format true
#   logstash_prefix preskool-logs
#   include_tag_key true
#   flush_interval 5s
#
#   <buffer>
#     @type file
#     path /var/log/fluentd-buffers/elasticsearch
#     flush_mode interval
#     flush_interval 5s
#     chunk_limit_size 2M
#     total_limit_size 256M
#   </buffer>
# </match>

# ── Output: AWS CloudWatch Logs (production) ─────────────────────────
# <match preskool.**>
#   @type cloudwatch_logs
#   region ap-south-1
#   log_group_name /preskool/${ENV['ENVIRONMENT']}/application
#   log_stream_name_key service
#   auto_create_stream true
#   put_log_events_retry_limit 5
# </match>

# ── Output: S3 Archive (long-term storage) ───────────────────────────
# <match preskool.**>
#   @type s3
#   s3_bucket preskool-logs-archive
#   s3_region ap-south-1
#   path logs/${ENV['ENVIRONMENT']}/%Y/%m/%d/
#   time_slice_format %Y%m%d%H
#   store_as gzip
#
#   <buffer>
#     @type file
#     path /var/log/fluentd-buffers/s3
#     flush_interval 3600
#     chunk_limit_size 256m
#   </buffer>
# </match>
