# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# PreSkool ERP â€” CD Pipeline (Railway + Vercel)
# Backend â†’ Railway  |  Frontend â†’ Vercel  |  Source â†’ GitHub
# Triggers: push to main (production), push to develop (staging)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
name: CD â€” Deploy (Railway + Vercel)

on:
  push:
    branches:
      - main
      - develop
  workflow_dispatch:
    inputs:
      environment:
        description: "Deploy environment"
        required: true
        default: production
        type: choice
        options:
          - staging
          - production

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # â”€â”€ Determine Environment â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  setup:
    name: ğŸ¯ Determine Environment
    runs-on: ubuntu-latest
    outputs:
      environment: ${{ steps.env.outputs.environment }}
    steps:
      - id: env
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "environment=${{ inputs.environment }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "environment=production" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
          fi

  # â”€â”€ Deploy Backend â†’ Railway â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-backend:
    name: ğŸš‚ Deploy Backend â†’ Railway
    runs-on: ubuntu-latest
    needs: setup
    environment:
      name: ${{ needs.setup.outputs.environment }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy to Railway
        working-directory: preskool-erp/backend
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          # Link to the correct Railway environment and deploy
          railway up \
            --service preskool-erp-backend \
            --environment ${{ needs.setup.outputs.environment }} \
            --detach

      - name: Wait for Railway deployment
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          echo "â³ Waiting for Railway deployment to finish..."
          sleep 30

      - name: Smoke-test backend health
        run: |
          # Pick the right URL based on environment
          if [[ "${{ needs.setup.outputs.environment }}" == "production" ]]; then
            URL="${{ secrets.RAILWAY_PRODUCTION_URL }}"
          else
            URL="${{ secrets.RAILWAY_STAGING_URL }}"
          fi

          echo "Testing health endpoint: $URL/api/v1/health"
          for i in 1 2 3 4 5; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$URL/api/v1/health" || echo "000")
            if [[ "$STATUS" == "200" ]]; then
              echo "âœ… Backend health check passed (attempt $i)"
              exit 0
            fi
            echo "â³ Attempt $i â€” status $STATUS, retrying in 15s..."
            sleep 15
          done
          echo "âŒ Backend health check failed after 5 attempts"
          exit 1

  # â”€â”€ Deploy Frontend â†’ Vercel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy-frontend:
    name: ğŸŒ Deploy Frontend â†’ Vercel
    runs-on: ubuntu-latest
    needs: [setup, deploy-backend]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: preskool-erp/frontend/package-lock.json

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Pull Vercel project settings
        working-directory: preskool-erp/frontend
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: vercel pull --yes --environment=${{ needs.setup.outputs.environment == 'production' && 'production' || 'preview' }} --token=$VERCEL_TOKEN

      - name: Build frontend
        working-directory: preskool-erp/frontend
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
          # Point frontend to the live Railway backend URL
          VITE_API_BASE_URL: ${{ needs.setup.outputs.environment == 'production' && secrets.RAILWAY_PRODUCTION_URL || secrets.RAILWAY_STAGING_URL }}
        run: vercel build ${{ needs.setup.outputs.environment == 'production' && '--prod' || '' }} --token=$VERCEL_TOKEN

      - name: Deploy to Vercel
        working-directory: preskool-erp/frontend
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        run: |
          if [[ "${{ needs.setup.outputs.environment }}" == "production" ]]; then
            vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN
          else
            vercel deploy --prebuilt --token=$VERCEL_TOKEN
          fi

  # â”€â”€ Final Summary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  summary:
    name: âœ… Deployment Summary
    runs-on: ubuntu-latest
    needs: [setup, deploy-backend, deploy-frontend]
    if: always()
    steps:
      - name: Print result
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "  PreSkool ERP â€” Deployment Summary"
          echo "  Environment : ${{ needs.setup.outputs.environment }}"
          echo "  Backend     : ${{ needs.deploy-backend.result }}"
          echo "  Frontend    : ${{ needs.deploy-frontend.result }}"
          echo "  Commit      : ${{ github.sha }}"
          echo "  Run         : ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [[ "${{ needs.deploy-backend.result }}" != "success" || \
                "${{ needs.deploy-frontend.result }}" != "success" ]]; then
            echo "âŒ One or more deployments failed â€” see above"
            exit 1
          fi
          echo "âœ… All deployments succeeded!"
